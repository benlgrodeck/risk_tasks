{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Bomb Risk Elicitation Task
{% endblock %}

{% block styles %}
<style>
    .bret-container {
        text-align: center;
        max-width: 550px;
        margin: 0 auto;
    }
    .grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        max-width: 400px;
        margin: 20px auto;
    }
    .box {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid #bdc3c7;
        border-radius: 8px;
        background: #ecf0f1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        color: #7f8c8d;
        transition: all 0.2s;
        user-select: none;
    }
    .box:hover:not(.revealed):not(.disabled) {
        background: #d5dbdb;
        border-color: #95a5a6;
    }
    .box.revealed {
        background: #d5f5e3;
        border-color: #27ae60;
        color: #27ae60;
        cursor: default;
    }
    .box.bomb-revealed {
        background: #fadbd8;
        border-color: #c0392b;
        color: #c0392b;
        cursor: default;
    }
    .box.disabled {
        cursor: default;
        opacity: 0.7;
    }
    .stats-bar {
        display: flex;
        justify-content: space-around;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 16px 0;
    }
    .stats-bar .stat {
        text-align: center;
    }
    .stats-bar .stat-value {
        font-size: 22px;
        font-weight: bold;
        color: #2c3e50;
    }
    .stats-bar .stat-label {
        color: #7f8c8d;
        font-size: 12px;
    }
    .btn-collect-pts {
        background: #f39c12;
        color: white;
        border: none;
        padding: 14px 40px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        margin: 16px 0;
        transition: background 0.2s;
    }
    .btn-collect-pts:hover { background: #d68910; }
    .btn-collect-pts:disabled { background: #95a5a6; cursor: not-allowed; }
    .outcome-message {
        font-size: 22px;
        font-weight: bold;
        margin: 16px 0;
        display: none;
    }
    .video-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .video-overlay.active {
        display: flex;
    }
    .video-overlay h2 {
        color: #ff4444;
        font-size: 32px;
        margin-bottom: 16px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .video-overlay .tiktok-wrapper {
        max-width: 360px;
        width: 90%;
    }
    .video-overlay .continue-btn {
        margin-top: 20px;
        background: #c0392b;
        color: white;
        border: none;
        padding: 12px 36px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
    }
    .video-overlay .continue-btn:hover {
        background: #a93226;
    }
</style>
{% endblock %}

{% block content %}
<div class="bret-container">
    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="boxesOpened">0</div>
            <div class="stat-label">Boxes Opened</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="potentialPts">0</div>
            <div class="stat-label">Potential Points</div>
        </div>
    </div>

    <div class="grid" id="grid"></div>

    <button class="btn-collect-pts" id="btnCollect" type="button">Collect Points</button>

    <div class="outcome-message" id="outcomeMsg"></div>

    <form id="form" method="post">
        {% csrf_token %}
        <input type="hidden" name="boxes_collected" id="id_boxes_collected" value="0">
        <input type="hidden" name="bomb_hit" id="id_bomb_hit" value="False">
    </form>
</div>

<div class="video-overlay" id="videoOverlay">
    <h2>WE BRING THE BOOM!</h2>
    <div class="tiktok-wrapper" id="tiktokWrapper"></div>
    <button class="continue-btn" id="continueBtn" type="button">Continue</button>
</div>

{% block scripts %}
<script>
    (function() {
        const numBoxes = {{ num_boxes }};
        const pointsPerBox = {{ points_per_box }};
        const bombLocation = {{ bomb_location }};
        let boxesOpened = 0;
        let finished = false;
        const openedSet = new Set();

        const grid = document.getElementById('grid');
        const boxesOpenedEl = document.getElementById('boxesOpened');
        const potentialPtsEl = document.getElementById('potentialPts');
        const btnCollect = document.getElementById('btnCollect');
        const outcomeMsg = document.getElementById('outcomeMsg');

        // Web Audio API
        let audioCtx;
        function getAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }
        function playClickSound() {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.08);
            } catch(e) {}
        }
        function playBombSound() {
            try {
                const ctx = getAudioCtx();
                const bufferSize = ctx.sampleRate * 0.5;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 1.5);
                }
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                source.connect(gain);
                gain.connect(ctx.destination);
                source.start();
            } catch(e) {}
        }
        function playSuccessSound() {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523, ctx.currentTime);
                osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.4);
            } catch(e) {}
        }

        // Build grid
        for (let i = 1; i <= numBoxes; i++) {
            const box = document.createElement('div');
            box.className = 'box';
            box.textContent = i;
            box.dataset.boxNum = i;
            box.addEventListener('click', function() {
                if (finished || openedSet.has(i)) return;
                openedSet.add(i);
                boxesOpened++;

                if (i === bombLocation) {
                    // Hit the bomb
                    finished = true;
                    box.textContent = '\uD83D\uDCA3';
                    box.classList.add('bomb-revealed');
                    playBombSound();
                    btnCollect.disabled = true;
                    document.querySelectorAll('.box').forEach(function(b) { b.classList.add('disabled'); });
                    boxesOpenedEl.textContent = boxesOpened;
                    potentialPtsEl.textContent = '0';
                    outcomeMsg.style.display = 'block';
                    outcomeMsg.style.color = '#c0392b';
                    outcomeMsg.textContent = 'You hit the bomb! You earned 0 points.';
                    document.getElementById('id_boxes_collected').value = boxesOpened;
                    document.getElementById('id_bomb_hit').value = 'True';

                    // Show TikTok video overlay
                    const videos = [
                        '7420922312519601454',  // We Bring The BOOM Remix Part 1 (with Rizzler)
                        '7551550497992264974'   // Can We Get 5 BIG BOOMS
                    ];
                    const videoId = videos[Math.floor(Math.random() * videos.length)];
                    const overlay = document.getElementById('videoOverlay');
                    const wrapper = document.getElementById('tiktokWrapper');
                    wrapper.innerHTML = '<blockquote class="tiktok-embed" cite="https://www.tiktok.com/@a.j.befumo/video/' + videoId + '" data-video-id="' + videoId + '" style="max-width:360px; min-width:300px;">' +
                        '<section></section></blockquote>';
                    // Load TikTok embed script
                    var s = document.createElement('script');
                    s.src = 'https://www.tiktok.com/embed.js';
                    s.async = true;
                    document.body.appendChild(s);
                    setTimeout(function() { overlay.classList.add('active'); }, 500);

                    document.getElementById('continueBtn').addEventListener('click', function() {
                        overlay.classList.remove('active');
                        document.getElementById('form').submit();
                    });
                } else {
                    box.textContent = '\uD83E\uDE99';
                    box.classList.add('revealed');
                    playClickSound();
                    boxesOpenedEl.textContent = boxesOpened;
                    potentialPtsEl.textContent = boxesOpened * pointsPerBox;
                }
            });
            grid.appendChild(box);
        }

        btnCollect.addEventListener('click', function() {
            if (finished || boxesOpened === 0) return;
            finished = true;
            btnCollect.disabled = true;
            document.querySelectorAll('.box').forEach(function(b) { b.classList.add('disabled'); });

            // Reveal bomb location
            const bombBox = grid.children[bombLocation - 1];
            if (!openedSet.has(bombLocation)) {
                bombBox.textContent = '\uD83D\uDCA3';
                bombBox.classList.add('bomb-revealed');
            }

            playSuccessSound();
            const pts = boxesOpened * pointsPerBox;
            outcomeMsg.style.display = 'block';
            outcomeMsg.style.color = '#27ae60';
            outcomeMsg.textContent = 'You collected ' + pts + ' points!';
            document.getElementById('id_boxes_collected').value = boxesOpened;
            document.getElementById('id_bomb_hit').value = 'False';
            setTimeout(function() {
                document.getElementById('form').submit();
            }, 1500);
        });
    })();
</script>
{% endblock %}
{% endblock %}
